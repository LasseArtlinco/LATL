<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LATL B√•nd Oversigt</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Allerta+Stencil&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="header">
            <h1>LATL B√•nd Oversigt</h1>
            <div>
                <button id="add-band-button" class="primary">Tilf√∏j nyt b√•nd</button>
            </div>
        </div>
        
        <div class="form-section">
            <h2>V√¶lg side</h2>
            <div class="form-group">
                <select id="page-select">
                    <option value="">-- V√¶lg side --</option>
                    <!-- Sider hentes fra API -->
                </select>
            </div>
        </div>
        
        <div id="bands-container" class="bands-container" style="display: none;">
            <h2>B√•nd p√• denne side</h2>
            <div id="bands-list" class="bands-list">
                <!-- B√•nd vises her -->
            </div>
        </div>
        
        <div id="no-bands-message" class="info-message" style="display: none;">
            <p>Ingen b√•nd fundet p√• denne side. Klik p√• "Tilf√∏j nyt b√•nd" for at oprette et.</p>
        </div>
    </div>
    
    <script src="js/admin-common.js"></script>
    <script>
        // Konstanter
        const API_URL = '/api';
        
        // DOM elementer
        const pageSelect = document.getElementById('page-select');
        const bandsContainer = document.getElementById('bands-container');
        const bandsList = document.getElementById('bands-list');
        const noBandsMessage = document.getElementById('no-bands-message');
        const addBandButton = document.getElementById('add-band-button');
        const loading = document.querySelector('.loading');
        const toast = document.getElementById('toast');
        
        // Event listeners
        pageSelect.addEventListener('change', loadBands);
        addBandButton.addEventListener('click', addNewBand);
        
        // Indl√¶s sider ved opstart
        document.addEventListener('DOMContentLoaded', loadPages);
        
        // Indl√¶s sider fra API
        async function loadPages() {
            try {
                showLoading();
                
                const response = await fetch(`${API_URL}/layout`);
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const pages = result.data;
                    
                    // Ryd eksisterende muligheder
                    pageSelect.innerHTML = '<option value="">-- V√¶lg side --</option>';
                    
                    // Tilf√∏j sider til dropdown (undtagen global)
                    pages.forEach(page => {
                        if (page.page_id !== 'global') {
                            const option = document.createElement('option');
                            option.value = page.page_id;
                            option.textContent = page.page_id;
                            pageSelect.appendChild(option);
                        }
                    });
                    
                    // Tjek URL for sidevalg
                    const urlParams = new URLSearchParams(window.location.search);
                    const pageId = urlParams.get('page');
                    
                    if (pageId) {
                        pageSelect.value = pageId;
                        loadBands();
                    }
                }
            } catch (error) {
                console.error('Fejl ved indl√¶sning af sider:', error);
                showToast('Fejl ved indl√¶sning af sider', true);
            } finally {
                hideLoading();
            }
        }
        
        // Indl√¶s b√•nd for den valgte side
        async function loadBands() {
            const selectedPageId = pageSelect.value;
            
            if (!selectedPageId) {
                bandsContainer.style.display = 'none';
                noBandsMessage.style.display = 'none';
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch(`${API_URL}/bands/${selectedPageId}`);
                const result = await response.json();
                
                // Opdater URL med sidevalg
                const url = new URL(window.location);
                url.searchParams.set('page', selectedPageId);
                window.history.pushState({}, '', url);
                
                if (result.status === 'success') {
                    const bands = result.data || [];
                    
                    if (bands.length === 0) {
                        bandsContainer.style.display = 'none';
                        noBandsMessage.style.display = 'block';
                    } else {
                        renderBands(bands);
                        bandsContainer.style.display = 'block';
                        noBandsMessage.style.display = 'none';
                    }
                } else {
                    showToast(result.message || 'Fejl ved indl√¶sning af b√•nd', true);
                    bandsContainer.style.display = 'none';
                    noBandsMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Fejl ved indl√¶sning af b√•nd:', error);
                showToast('Fejl ved indl√¶sning af b√•nd', true);
                bandsContainer.style.display = 'none';
                noBandsMessage.style.display = 'block';
            } finally {
                hideLoading();
            }
        }
        
        // Render b√•nd liste
        function renderBands(bands) {
            // T√∏m b√•nd liste
            bandsList.innerHTML = '';
            
            // Sorter b√•nd efter r√¶kkef√∏lge
            bands.sort((a, b) => a.band_order - b.band_order);
            
            // Opret HTML for hvert b√•nd
            bands.forEach((band, index) => {
                const bandEl = document.createElement('div');
                bandEl.className = 'band-item';
                bandEl.dataset.bandId = band.band_id;
                
                // B√•nd type ikon/billede
                let typeIcon = '';
                if (band.band_type === 'slideshow') {
                    typeIcon = '<span class="band-icon slideshow-icon">üñºÔ∏è</span>';
                } else if (band.band_type === 'product') {
                    typeIcon = '<span class="band-icon product-icon">üõçÔ∏è</span>';
                }
                
                // B√•nd indhold baseret p√• type
                let contentPreview = '';
                if (band.band_type === 'slideshow') {
                    const slides = band.band_content.slides || [];
                    contentPreview = `<span class="band-meta">${slides.length} slide(s)</span>`;
                } else if (band.band_type === 'product') {
                    const title = band.band_content.title || 'Uden titel';
                    contentPreview = `<span class="band-meta">${title}</span>`;
                }
                
                // Band position/height indikator
                const heightLabel = `${band.band_height}x h√∏jde`;
                const orderLabel = `Position: ${band.band_order}`;
                
                // Knapper
                const buttonsHtml = `
                    <div class="band-actions">
                        <button class="edit-band-btn" data-band-id="${band.band_id}" title="Rediger b√•nd">‚úèÔ∏è</button>
                        <button class="move-up-btn" data-band-id="${band.band_id}" title="Flyt op" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="move-down-btn" data-band-id="${band.band_id}" title="Flyt ned" ${index === bands.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button class="delete-band-btn" data-band-id="${band.band_id}" title="Slet b√•nd">üóëÔ∏è</button>
                    </div>
                `;
                
                // Samlet band HTML
                bandEl.innerHTML = `
                    <div class="band-header">
                        <div class="band-info">
                            ${typeIcon}
                            <h3 class="band-title">${band.band_type.charAt(0).toUpperCase() + band.band_type.slice(1)}</h3>
                            ${contentPreview}
                        </div>
                        ${buttonsHtml}
                    </div>
                    <div class="band-meta-info">
                        <span class="band-meta">${heightLabel}</span>
                        <span class="band-meta">${orderLabel}</span>
                    </div>
                `;
                
                bandsList.appendChild(bandEl);
                
                // Tilf√∏j event listeners til knapper
                const editBtn = bandEl.querySelector('.edit-band-btn');
                const moveUpBtn = bandEl.querySelector('.move-up-btn');
                const moveDownBtn = bandEl.querySelector('.move-down-btn');
                const deleteBtn = bandEl.querySelector('.delete-band-btn');
                
                editBtn.addEventListener('click', () => editBand(band.band_id));
                moveUpBtn.addEventListener('click', () => moveBand(band.band_id, -1));
                moveDownBtn.addEventListener('click', () => moveBand(band.band_id, 1));
                deleteBtn.addEventListener('click', () => deleteBand(band.band_id));
            });
        }
        
        // Tilf√∏j nyt b√•nd
        function addNewBand() {
            const selectedPageId = pageSelect.value;
            
            if (!selectedPageId) {
                showToast('V√¶lg venligst en side f√∏rst', true);
                return;
            }
            
            window.location.href = `band_editor.html?page=${selectedPageId}`;
        }
        
        // Rediger et b√•nd
        function editBand(bandId) {
            const selectedPageId = pageSelect.value;
            window.location.href = `band_editor.html?page=${selectedPageId}&id=${bandId}`;
        }
        
        // Flyt et b√•nd op eller ned
        async function moveBand(bandId, direction) {
            const selectedPageId = pageSelect.value;
            
            try {
                showLoading();
                
                // Hent alle b√•nd
                const response = await fetch(`${API_URL}/bands/${selectedPageId}`);
                const result = await response.json();
                
                if (result.status !== 'success') {
                    showToast(result.message || 'Fejl ved flytning af b√•nd', true);
                    return;
                }
                
                const bands = result.data || [];
                
                // Find b√•ndet og dets nabo
                let bandIndex = -1;
                let band = null;
                
                for (let i = 0; i < bands.length; i++) {
                    if (bands[i].band_id === bandId) {
                        bandIndex = i;
                        band = bands[i];
                        break;
                    }
                }
                
                if (bandIndex === -1 || !band) {
                    showToast('B√•nd ikke fundet', true);
                    return;
                }
                
                const newIndex = bandIndex + direction;
                
                // Kontroller at det nye index er gyldigt
                if (newIndex < 0 || newIndex >= bands.length) {
                    return;
                }
                
                const neighborBand = bands[newIndex];
                
                // Byt om p√• r√¶kkef√∏lgen
                const tempOrder = band.band_order;
                band.band_order = neighborBand.band_order;
                neighborBand.band_order = tempOrder;
                
                // Opdater begge b√•nd
                const updateBand1 = await fetch(`${API_URL}/bands/${selectedPageId}/${band.band_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ band_order: band.band_order })
                });
                
                const updateBand2 = await fetch(`${API_URL}/bands/${selectedPageId}/${neighborBand.band_id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ band_order: neighborBand.band_order })
                });
                
                // Genindl√¶s b√•nd
                await loadBands();
                
                showToast('B√•ndets position blev √¶ndret');
            } catch (error) {
                console.error('Fejl ved flytning af b√•nd:', error);
                showToast('Fejl ved flytning af b√•nd', true);
            } finally {
                hideLoading();
            }
        }
        
        // Slet et b√•nd
        async function deleteBand(bandId) {
            const selectedPageId = pageSelect.value;
            
            if (!confirm('Er du sikker p√•, at du vil slette dette b√•nd?')) {
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch(`${API_URL}/bands/${selectedPageId}/${bandId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showToast('B√•ndet blev slettet');
                    await loadBands();
                } else {
                    showToast(result.message || 'Fejl ved sletning af b√•nd', true);
                }
            } catch (error) {
                console.error('Fejl ved sletning af b√•nd:', error);
                showToast('Fejl ved sletning af b√•nd', true);
            } finally {
                hideLoading();
            }
        }
        
        // Hj√¶lpefunktioner
        function showLoading() {
            loading.classList.add('show');
        }
        
        function hideLoading() {
            loading.classList.remove('show');
        }
        
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = isError ? 'toast error show' : 'toast show';
            
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
    </script>
</body>
</html>
