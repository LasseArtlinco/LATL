<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LATL Bånd Oversigt</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Allerta+Stencil&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
    <style>
        .band-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
            position: relative;
        }
        
        .band-type-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .band-type-badge.slideshow {
            background-color: var(--primary-color);
            color: white;
        }
        
        .band-type-badge.product {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .band-info {
            margin-bottom: 15px;
        }
        
        .band-title {
            margin-bottom: 5px;
        }
        
        .band-details {
            color: var(--dark-gray);
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .band-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px dashed var(--medium-gray);
            margin: 30px 0;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--dark-gray);
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            margin-bottom: 0;
        }
        
        .page-actions {
            display: flex;
            gap: 10px;
        }
        
        .page-selector {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">LATL Bånd Oversigt</h1>
            <div class="page-actions">
                <button id="back-to-admin" class="secondary">Tilbage til admin</button>
            </div>
        </div>
        
        <div class="page-selector">
            <label for="page-select">Vælg side:</label>
            <select id="page-select">
                <option value="">-- Vælg side --</option>
                <!-- Sider hentes fra API -->
            </select>
        </div>
        
        <div id="bands-container">
            <!-- Bånd indlæses her dynamisk -->
            <div class="empty-state">
                <h3>Vælg en side for at se bånd</h3>
                <p>Vælg en side fra dropdown-menuen ovenfor for at se og administrere bånd.</p>
            </div>
        </div>
    </div>
    
    <script>
        // API URL konfiguration
        const API_URL = '/api';
        
        // DOM elementer
        const pageSelect = document.getElementById('page-select');
        const bandsContainer = document.getElementById('bands-container');
        const backToAdminButton = document.getElementById('back-to-admin');
        const toast = document.getElementById('toast');
        const loading = document.querySelector('.loading');
        
        // Event listeners
        pageSelect.addEventListener('change', loadBands);
        backToAdminButton.addEventListener('click', () => {
            window.location.href = 'layout.html';
        });
        
        // Initialiser app
        document.addEventListener('DOMContentLoaded', init);
        
        /**
         * Initialiser applikationen
         */
        async function init() {
            try {
                // Indlæs sider fra API
                await loadPages();
                
                // Tjek om der er en side parameter i URL'en
                const urlParams = new URLSearchParams(window.location.search);
                const pageId = urlParams.get('page');
                
                if (pageId) {
                    pageSelect.value = pageId;
                    await loadBands();
                }
            } catch (error) {
                console.error('Fejl ved initialisering:', error);
                showToast('Der opstod en fejl ved indlæsning af applikationen', true);
            }
        }
        
        /**
         * Indlæs sider fra API
         */
        async function loadPages() {
            try {
                showLoading();
                
                const response = await fetch(`${API_URL}/layout`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const pages = result.data;
                    
                    // Ryd eksisterende muligheder
                    pageSelect.innerHTML = '<option value="">-- Vælg side --</option>';
                    
                    // Tilføj sider til dropdown
                    pages.forEach(page => {
                        if (page.page_id !== 'global') {
                            const option = document.createElement('option');
                            option.value = page.page_id;
                            option.textContent = page.page_id;
                            pageSelect.appendChild(option);
                        }
                    });
                } else {
                    throw new Error(result.message || 'Der skete en fejl ved hentning af sider');
                }
            } catch (error) {
                console.error('Fejl ved hentning af sider:', error);
                showToast('Fejl ved hentning af sider', true);
            } finally {
                hideLoading();
            }
        }
        
        /**
         * Indlæs bånd for den valgte side
         */
        async function loadBands() {
            const selectedPageId = pageSelect.value;
            
            if (!selectedPageId) {
                bandsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>Vælg en side for at se bånd</h3>
                        <p>Vælg en side fra dropdown-menuen ovenfor for at se og administrere bånd.</p>
                    </div>
                `;
                return;
            }
            
            try {
                showLoading();
                
                // Opdater URL med pageId
                const url = new URL(window.location);
                url.searchParams.set('page', selectedPageId);
                window.history.pushState({}, '', url);
                
                const response = await fetch(`${API_URL}/bands/${selectedPageId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const bands = result.data || [];
                    
                    if (bands.length === 0) {
                        bandsContainer.innerHTML = `
                            <div class="empty-state">
                                <h3>Ingen bånd fundet</h3>
                                <p>Der er ingen bånd på denne side endnu. Opret et nyt bånd for at komme i gang.</p>
                            </div>
                            <button id="add-band-button" class="primary">Tilføj nyt bånd</button>
                        `;
                        
                        // Tilføj event listener til "Tilføj nyt bånd" knappen
                        document.getElementById('add-band-button').addEventListener('click', () => {
                            window.location.href = `band_editor.html?page=${selectedPageId}`;
                        });
                    } else {
                        // Sorter bånd efter rækkefølge
                        bands.sort((a, b) => a.band_order - b.band_order);
                        
                        let bandsHtml = '<div class="band-list">';
                        
                        bands.forEach(band => {
                            let bandTitle = '';
                            let bandDescription = '';
                            
                            if (band.band_type === 'slideshow') {
                                const slides = band.band_content?.slides || [];
                                bandTitle = slides[0]?.title || 'Unavngivet slideshow';
                                bandDescription = `${slides.length} slide${slides.length !== 1 ? 's' : ''}`;
                            } else if (band.band_type === 'product') {
                                bandTitle = band.band_content?.title || 'Unavngivet produkt';
                                bandDescription = band.band_content?.subtitle || '';
                            } else {
                                bandTitle = `${band.band_type} bånd`;
                                bandDescription = 'Ingen beskrivelse';
                            }
                            
                            bandsHtml += `
                                <div class="band-card">
                                    <div class="band-type-badge ${band.band_type}">${getBandTypeName(band.band_type)}</div>
                                    <div class="band-info">
                                        <h3 class="band-title">${bandTitle}</h3>
                                        <div class="band-details">
                                            ${bandDescription}<br>
                                            Højde: ${band.band_height}x · Position: ${band.band_order}
                                        </div>
                                    </div>
                                    <div class="band-actions">
                                        <button class="edit-band" data-band-id="${band.band_id}">Rediger</button>
                                        <button class="delete-band" data-band-id="${band.band_id}">Slet</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        bandsHtml += '</div>';
                        bandsHtml += '<button id="add-band-button" class="primary">Tilføj nyt bånd</button>';
                        
                        bandsContainer.innerHTML = bandsHtml;
                        
                        // Tilføj event listeners til knapper
                        document.querySelectorAll('.edit-band').forEach(button => {
                            button.addEventListener('click', () => {
                                const bandId = button.dataset.bandId;
                                window.location.href = `band_editor.html?page=${selectedPageId}&id=${bandId}`;
                            });
                        });
                        
                        document.querySelectorAll('.delete-band').forEach(button => {
                            button.addEventListener('click', async () => {
                                const bandId = button.dataset.bandId;
                                await deleteBand(selectedPageId, bandId);
                            });
                        });
                        
                        document.getElementById('add-band-button').addEventListener('click', () => {
                            window.location.href = `band_editor.html?page=${selectedPageId}`;
                        });
                    }
                } else {
                    throw new Error(result.message || 'Der skete en fejl ved hentning af bånd');
                }
            } catch (error) {
                console.error('Fejl ved hentning af bånd:', error);
                showToast('Fejl ved hentning af bånd', true);
                
                bandsContainer.innerHTML = `
                    <div class="empty-state">
                        <h3>Fejl ved indlæsning</h3>
                        <p>${error.message || 'Der opstod en fejl ved indlæsning af bånd. Prøv igen senere.'}</p>
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }
        
        /**
         * Slet et bånd
         */
        async function deleteBand(pageId, bandId) {
            if (!confirm('Er du sikker på, at du vil slette dette bånd?')) {
                return;
            }
            
            try {
                showLoading();
                
                const response = await fetch(`${API_URL}/bands/${pageId}/${bandId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showToast('Båndet blev slettet');
                    await loadBands(); // Genindlæs båndene
                } else {
                    throw new Error(result.message || 'Der skete en fejl ved sletning af båndet');
                }
            } catch (error) {
                console.error('Fejl ved sletning af bånd:', error);
                showToast('Fejl ved sletning af bånd: ' + error.message, true);
            } finally {
                hideLoading();
            }
        }
        
        /**
         * Få læsevenligt navn for båndtype
         */
        function getBandTypeName(type) {
            const typeNames = {
                'slideshow': 'Slideshow',
                'product': 'Produkt',
                'product_card': 'Produktkort',
                'product_full': 'Produkt fuld',
                'html': 'HTML',
                'related_products': 'Relaterede produkter',
                'link': 'Link',
                'cta': 'Call to Action'
            };
            
            return typeNames[type] || type;
        }
        
        /**
         * Vis loading spinner
         */
        function showLoading() {
            loading.classList.add('show');
        }
        
        /**
         * Skjul loading spinner
         */
        function hideLoading() {
            loading.classList.remove('show');
        }
        
        /**
         * Vis toast besked
         */
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = isError ? 'toast error show' : 'toast show';
            
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
    </script>
</body>
</html>
