<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LATL Layout Admin</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Allerta+Stencil&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <div class="container">
        <div class="header">
            <h1>LATL Admin Dashboard</h1>
            <button id="saveButton" class="primary">Gem ændringer</button>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="globalStyles">Globale stilarter</div>
            <div class="nav-tab" data-tab="layoutPages">Layout sider</div>
            <div class="nav-tab" data-tab="bandManagement">Bånd-styring</div>
        </div>
        
        <!-- Global Styles Tab -->
        <div class="tab-content active" id="globalStyles">
            <h2>Globale stilarter</h2>
            <p>Her kan du konfigurere globale stilarter, der anvendes på hele webstedet.</p>
            
            <div class="form-row">
                <div>
                    <h3>Farvepalette</h3>
                    <div id="colorPalette">
                        <div class="form-group">
                            <label>Primær farve (#042940)</label>
                            <div class="form-row">
                                <input type="color" id="primaryColor" value="#042940">
                                <input type="text" id="primaryColorHex" value="#042940">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Sekundær farve (#005C53)</label>
                            <div class="form-row">
                                <input type="color" id="secondaryColor" value="#005C53">
                                <input type="text" id="secondaryColorHex" value="#005C53">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Accent farve (#9FC131)</label>
                            <div class="form-row">
                                <input type="color" id="accentColor" value="#9FC131">
                                <input type="text" id="accentColorHex" value="#9FC131">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Lys accent farve (#DBF227)</label>
                            <div class="form-row">
                                <input type="color" id="brightColor" value="#DBF227">
                                <input type="text" id="brightColorHex" value="#DBF227">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Baggrund (#D6D58E)</label>
                            <div class="form-row">
                                <input type="color" id="backgroundColor" value="#D6D58E">
                                <input type="text" id="backgroundColorHex" value="#D6D58E">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Tekstfarve (#042940)</label>
                            <div class="form-row">
                                <input type="color" id="textColor" value="#042940">
                                <input type="text" id="textColorHex" value="#042940">
                            </div>
                        </div>
                        
                        <div class="form-section" style="margin-top: 20px;">
                            <h4>Farvepalette forhåndsvisning</h4>
                            <div id="color-preview-container" style="display: flex; gap: 10px; margin-top: 10px;">
                                <div style="width: 80px; height: 80px; background-color: #042940; display: flex; align-items: center; justify-content: center; color: white; border-radius: 4px;">Primær</div>
                                <div style="width: 80px; height: 80px; background-color: #005C53; display: flex; align-items: center; justify-content: center; color: white; border-radius: 4px;">Sekundær</div>
                                <div style="width: 80px; height: 80px; background-color: #9FC131; display: flex; align-items: center; justify-content: center; color: white; border-radius: 4px;">Accent</div>
                                <div style="width: 80px; height: 80px; background-color: #DBF227; display: flex; align-items: center; justify-content: center; color: #042940; border-radius: 4px;">Lys Accent</div>
                                <div style="width: 80px; height: 80px; background-color: #D6D58E; display: flex; align-items: center; justify-content: center; color: #042940; border-radius: 4px;">Baggrund</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3>Skrifttyper</h3>
                    <div id="fontConfig">
                        <div class="form-group">
                            <label>Overskrift skrifttype</label>
                            <select id="headingFontFamily">
                                <option value="'Allerta Stencil', sans-serif" selected>Allerta Stencil</option>
                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Montserrat', sans-serif">Montserrat</option>
                                <option value="'Raleway', sans-serif">Raleway</option>
                                <option value="'Playfair Display', serif">Playfair Display</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Overskrift tykkelse</label>
                            <select id="headingFontWeight">
                                <option value="400" selected>Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-bold (600)</option>
                                <option value="700">Bold (700)</option>
                                <option value="800">Extra-bold (800)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Brødtekst skrifttype</label>
                            <select id="bodyFontFamily">
                                <option value="'Open Sans', sans-serif" selected>Open Sans</option>
                                <option value="'Allerta Stencil', sans-serif">Allerta Stencil</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Lato', sans-serif">Lato</option>
                                <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                                <option value="'PT Sans', sans-serif">PT Sans</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Brødtekst tykkelse</label>
                            <select id="bodyFontWeight">
                                <option value="300">Light (300)</option>
                                <option value="400" selected>Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-bold (600)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Pris skrifttype</label>
                            <select id="priceFontFamily">
                                <option value="'Allerta Stencil', sans-serif" selected>Allerta Stencil</option>
                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Montserrat', sans-serif">Montserrat</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Pris tykkelse</label>
                            <select id="priceFontWeight">
                                <option value="400" selected>Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-bold (600)</option>
                                <option value="700">Bold (700)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Knap skrifttype</label>
                            <select id="buttonFontFamily">
                                <option value="'Open Sans', sans-serif" selected>Open Sans</option>
                                <option value="'Allerta Stencil', sans-serif">Allerta Stencil</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Knap tykkelse</label>
                            <select id="buttonFontWeight">
                                <option value="400">Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600" selected>Semi-bold (600)</option>
                                <option value="700">Bold (700)</option>
                            </select>
                        </div>
                        
                        <div class="form-section" style="margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 4px;">
                            <h4 style="font-family: var(--heading-font); margin-bottom: 10px;" class="preview-heading">Skrifttype Forhåndsvisning</h4>
                            <p style="font-family: var(--body-font); margin-bottom: 10px;" class="preview-body">Dette er et eksempel på brødtekst, der viser hvordan den valgte skrifttype ser ud i praksis.</p>
                            <div style="font-family: var(--price-font); font-size: 1.2rem; margin-bottom: 10px;" class="preview-price">299,00 kr.</div>
                            <button style="font-family: var(--button-font); padding: 8px 16px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px;" class="preview-button">Køb nu</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <h3>Global styling</h3>
            <div class="form-group">
                <label>CSS kode (avanceret)</label>
                <textarea id="globalCss" rows="10" placeholder="Indtast din CSS-kode her...">/* Eksempel på global styling */
body {
  line-height: 1.6;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 15px;
}

.button {
  transition: all 0.3s ease;
}

.button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}</textarea>
            </div>
        </div>
        
        <!-- Layout Pages Tab -->
        <div class="tab-content" id="layoutPages">
            <h2>Layout sider</h2>
            <p>Her kan du se og redigere layouts for forskellige sider.</p>
            
            <div class="form-row">
                <div>
                    <label>Vælg side</label>
                    <select id="pageSelect">
                        <option value="">-- Vælg side --</option>
                    </select>
                </div>
                <div>
                    <label>Eller opret ny side</label>
                    <div class="form-row">
                        <input type="text" id="newPageId" placeholder="Indtast side-id (f.eks. 'forside')">
                        <button id="createPageButton">Opret</button>
                    </div>
                </div>
            </div>
            
            <div id="pageDetails" style="display: none;">
                <h3>Side detaljer</h3>
                <div class="form-group">
                    <label>Side ID</label>
                    <input type="text" id="currentPageId" disabled>
                </div>
                
                <h3>Layout data</h3>
                <div class="form-group">
                    <label>Layout data (JSON)</label>
                    <textarea id="layoutData" rows="10" placeholder="Layout data i JSON format..."></textarea>
                </div>
                
                <div class="form-row">
                    <button id="updatePageButton">Opdater side</button>
                    <button id="deletePageButton" class="danger">Slet side</button>
                </div>
            </div>
        </div>
        
        <!-- Band Management Tab -->
        <div class="tab-content" id="bandManagement">
            <h2>Bånd-styring</h2>
            <p>Her kan du styre bånd for den valgte side.</p>
            
            <!-- Band List View -->
            <div id="band-list-view">
                <div class="form-group">
                    <label>Vælg side</label>
                    <select id="bandPageSelect">
                        <option value="">-- Vælg side --</option>
                    </select>
                </div>
                
                <div id="bandList" style="display: none; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Bånd på denne side</h3>
                        <button id="addBandButton" class="secondary">Tilføj nyt bånd</button>
                    </div>
                    
                    <div id="bands"></div>
                </div>
            </div>
            
            <!-- Band Editor View -->
            <div id="band-editor-view" style="display: none;">
                <div class="header">
                    <h3 id="band-editor-title">Tilføj nyt bånd</h3>
                    <div>
                        <button id="cancelBandButton" class="secondary">Annuller</button>
                        <button id="saveBandButton" class="primary">Gem bånd</button>
                    </div>
                </div>
                
                <input type="hidden" id="editBandId">
                
                <div class="form-section">
                    <h3>Grundlæggende bånd information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="band-type">Bånd type</label>
                            <select id="band-type">
                                <option value="slideshow">Slideshow</option>
                                <option value="product">Produkt (konfigurerbart)</option>
                                <option value="product_card">Produkt kort</option>
                                <option value="product_full">Produkt fuld</option>
                                <option value="html">HTML</option>
                                <option value="related_products">Relaterede produkter</option>
                                <option value="link">Link</option>
                                <option value="cta">Call to Action</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="band-height">Bånd højde</label>
                            <select id="band-height">
                                <option value="1">1x</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="4">4x</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="band-order">Rækkefølge</label>
                            <input type="number" id="band-order" min="1" value="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="band-page">Side</label>
                        <select id="band-page" disabled>
                            <option value="">-- Vælg side --</option>
                        </select>
                    </div>
                </div>
                
                <!-- Slideshow Editor -->
                <div id="slideshow-editor" class="form-section">
                    <h3>Slideshow indstillinger</h3>
                    
                    <button id="add-slide" class="add-slide-btn">Tilføj nyt slide</button>
                    
                    <div id="slides-container">
                        <!-- Slides tilføjes her dynamisk -->
                    </div>
                </div>
                
                <!-- Configurable Product Editor -->
                <div id="product-editor" class="form-section hidden-tab">
                    <h3>Produkt indstillinger</h3>
                    
                    <div class="form-group">
                        <label for="product-title">Titel</label>
                        <input type="text" id="product-title" placeholder="Indtast produkttitel">
                    </div>
                    
                    <div class="form-group">
                        <label for="product-subtitle">Undertitel</label>
                        <input type="text" id="product-subtitle" placeholder="Indtast undertitel">
                    </div>
                    
                    <div class="form-group">
                        <label for="product-link">Link (valgfrit)</label>
                        <input type="text" id="product-link" placeholder="f.eks. /produkt/læderprodukt">
                    </div>
                    
                    <div class="form-group">
                        <label for="product-background">Baggrundsfarve</label>
                        <div class="form-row">
                            <input type="color" id="product-background" value="#ffffff">
                            <input type="text" id="product-background-hex" value="#ffffff">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-image">Produkt billede (PNG med gennemsigtig baggrund)</label>
                        <div id="product-image-preview" class="image-preview" style="display: none;">
                            <img src="" alt="Produkt forhåndsvisning">
                        </div>
                        <input type="file" id="product-image" accept="image/png">
                    </div>
                </div>
                
                <!-- HTML Editor -->
                <div id="html-editor" class="form-section hidden-tab">
                    <h3>HTML indstillinger</h3>
                    
                    <div class="form-group">
                        <label for="html-content">HTML indhold</label>
                        <textarea id="html-content" rows="10" placeholder="Indtast HTML-kode her..."></textarea>
                    </div>
                </div>
                
                <!-- Link Editor -->
                <div id="link-editor" class="form-section hidden-tab">
                    <h3>Link indstillinger</h3>
                    
                    <div class="form-group">
                        <label for="link-text">Link tekst</label>
                        <input type="text" id="link-text" placeholder="Indtast link tekst">
                    </div>
                    
                    <div class="form-group">
                        <label for="link-url">URL</label>
                        <input type="text" id="link-url" placeholder="Indtast URL (f.eks. /kontakt)">
                    </div>
                    
                    <div class="form-group">
                        <label for="link-style">Link stil</label>
                        <select id="link-style">
                            <option value="button">Knap</option>
                            <option value="text">Tekst</option>
                        </select>
                    </div>
                </div>
                
                <!-- SEO indstillinger -->
                <div class="form-section">
                    <h3>SEO indstillinger</h3>
                    
                    <div class="form-group">
                        <label for="seo-title">SEO Titel</label>
                        <input type="text" id="seo-title" placeholder="Indtast SEO titel">
                        <p class="help-text">Denne titel vil blive brugt i metadata og hjælper med SEO.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="seo-description">SEO Beskrivelse</label>
                        <textarea id="seo-description" rows="3" placeholder="Indtast SEO beskrivelse"></textarea>
                        <p class="help-text">En kort beskrivelse af båndets indhold for søgemaskiner.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="seo-keywords">SEO Nøgleord</label>
                        <input type="text" id="seo-keywords" placeholder="Indtast nøgleord adskilt af komma">
                        <p class="help-text">Relevante nøgleord for dette bånd.</p>
                    </div>
                </div>
                
                <!-- Preview section -->
                <div class="form-section">
                    <h3>Forhåndsvisning</h3>
                    <div id="preview-container" class="preview-container" style="margin-top: 10px; padding: 15px; background-color: #f5f5f5; border-radius: 4px; min-height: 200px;">
                        <!-- Preview renderes her dynamisk -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Slide template (skjult) -->
    <template id="slide-template">
        <div class="slide-container" data-slide-index="{index}">
            <button class="remove-slide" title="Fjern slide">&times;</button>
            
            <div class="slide-header">
                <h3>Slide {index_human}</h3>
                <div class="slide-controls">
                    <button class="move-slide-up" title="Flyt op">&#8593;</button>
                    <button class="move-slide-down" title="Flyt ned">&#8595;</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="slide-title-{index}">Titel</label>
                <input type="text" id="slide-title-{index}" class="slide-title" placeholder="Indtast slide titel">
            </div>
            
            <div class="form-group">
                <label for="slide-subtitle-{index}">Undertitel</label>
                <input type="text" id="slide-subtitle-{index}" class="slide-subtitle" placeholder="Indtast undertitel">
            </div>
            
            <div class="form-group">
                <label for="slide-link-{index}">Link (valgfrit)</label>
                <input type="text" id="slide-link-{index}" class="slide-link" placeholder="f.eks. /produkt/læderprodukt">
            </div>
            
            <div class="form-group">
                <label for="slide-image-{index}">Slide billede</label>
                <div class="image-preview slide-image-preview" style="display: none;">
                    <img src="" alt="Slide forhåndsvisning">
                </div>
                <input type="file" id="slide-image-{index}" class="slide-image" accept="image/jpeg,image/png,image/webp">
            </div>
            
            <div class="form-group">
                <label for="slide-alt-{index}">Billedtekst (alt-tekst)</label>
                <input type="text" id="slide-alt-{index}" class="slide-alt" placeholder="Beskrivende tekst til billedet for SEO">
                <p class="help-text">En beskrivende tekst til billedet, der hjælper med tilgængelighed og SEO.</p>
            </div>
        </div>
    </template>
    
    <!-- Band Item Template -->
    <template id="band-item-template">
        <div class="band" data-band-id="{id}">
            <div class="band-header">
                <h4>{title}</h4>
                <div class="band-controls">
                    <button class="edit-band-btn">Rediger</button>
                    <button class="move-up-btn" title="Flyt op">↑</button>
                    <button class="move-down-btn" title="Flyt ned">↓</button>
                    <button class="delete-band-btn danger" title="Slet">×</button>
                </div>
            </div>
            <div class="band-info">
                <p><strong>Type:</strong> {type}</p>
                <p><strong>Højde:</strong> {height}x</p>
                <p><strong>Position:</strong> {order}</p>
                <p>{content_info}</p>
            </div>
        </div>
    </template>
    
    <script src="js/admin-common.js"></script>
    <script>
        // API-adresse
        const API_URL = '/api';
        
        // DOM elementer
        const tabButtons = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const toast = document.getElementById('toast');
        const loading = document.querySelector('.loading');
        
        // Global state
        let currentPageId = null;
        let layouts = [];
        let globalStyles = {
            global_styles: {},
            font_config: {},
            color_palette: {}
        };
        let slideCount = 0;
        let slideImageFiles = {};
        let productImageFile = null;
        
        // Event listeners for tabs
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                // Skift aktiv fane
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // Opdater indhold baseret på valgt fane
                if (tabId === 'layoutPages' || tabId === 'bandManagement') {
                    loadLayouts();
                } else if (tabId === 'globalStyles') {
                    loadGlobalStyles();
                }
            });
        });
        
        // Farvepalette event listeners
        document.querySelectorAll('input[type="color"]').forEach(colorInput => {
            const hexInput = document.getElementById(colorInput.id + 'Hex');
            
            colorInput.addEventListener('input', () => {
                hexInput.value = colorInput.value;
                updateColorPreview();
            });
            
            hexInput.addEventListener('input', () => {
                if (/^#[0-9A-F]{6}$/i.test(hexInput.value)) {
                    colorInput.value = hexInput.value;
                    updateColorPreview();
                }
            });
        });
        
        // Font selects
        document.querySelectorAll('#fontConfig select').forEach(select => {
            select.addEventListener('change', updateFontPreview);
        });
        
        // Global styles
        document.getElementById('saveButton').addEventListener('click', saveGlobalStyles);
        
        // Layout pages
        document.getElementById('pageSelect').addEventListener('change', handlePageChange);
        document.getElementById('createPageButton').addEventListener('click', createNewPage);
        document.getElementById('updatePageButton').addEventListener('click', updatePage);
        document.getElementById('deletePageButton').addEventListener('click', deletePage);
        
        // Band management
        document.getElementById('bandPageSelect').addEventListener('change', loadBands);
        document.getElementById('addBandButton').addEventListener('click', showBandEditor);
        document.getElementById('cancelBandButton').addEventListener('click', hideBandEditor);
        document.getElementById('saveBandButton').addEventListener('click', saveBand);
        document.getElementById('band-type').addEventListener('change', toggleEditors);
        document.getElementById('add-slide').addEventListener('click', addSlide);
        
        // Initialiser app
        document.addEventListener('DOMContentLoaded', init);
        
        async function init() {
            await loadGlobalStyles();
            await loadLayouts();
        }
        
        // Helper funktion til at vise toast meddelelser
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = isError ? 'toast error show' : 'toast show';
            
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
        
        // Helper funktion til at håndtere API-kald
        async function fetchApi(endpoint, method = 'GET', data = null) {
            try {
                loading.classList.add('show');
                
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (data && (method === 'POST' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_URL}/${endpoint}`, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Der skete en fejl');
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message || 'Der skete en fejl ved kommunikation med serveren', true);
                throw error;
            } finally {
                loading.classList.remove('show');
            }
        }
        
        // Load globale stilarter
        async function loadGlobalStyles() {
            try {
                const result = await fetchApi('layout/global/styles');
                
                if (result.status === 'success' && result.data) {
                    globalStyles = result.data;
                    
                    // Opdater UI med indlæste data
                    const colorPalette = globalStyles.color_palette || {};
                    const fontConfig = globalStyles.font_config || {};
                    const styles = globalStyles.global_styles || {};
                    
                    // Opdater farver
                    if (colorPalette.primary) {
                        document.getElementById('primaryColor').value = colorPalette.primary;
                        document.getElementById('primaryColorHex').value = colorPalette.primary;
                    }
                    
                    if (colorPalette.secondary) {
                        document.getElementById('secondaryColor').value = colorPalette.secondary;
                        document.getElementById('secondaryColorHex').value = colorPalette.secondary;
                    }
                    
                    if (colorPalette.accent) {
                        document.getElementById('accentColor').value = colorPalette.accent;
                        document.getElementById('accentColorHex').value = colorPalette.accent;
                    }
                    
                    if (colorPalette.bright) {
                        document.getElementById('brightColor').value = colorPalette.bright;
                        document.getElementById('brightColorHex').value = colorPalette.bright;
                    }
                    
                    if (colorPalette.background) {
                        document.getElementById('backgroundColor').value = colorPalette.background;
                        document.getElementById('backgroundColorHex').value = colorPalette.background;
                    }
                    
                    if (colorPalette.text) {
                        document.getElementById('textColor').value = colorPalette.text;
                        document.getElementById('textColorHex').value = colorPalette.text;
                    }
                    
                    // Opdater skrifttyper
                    if (fontConfig.heading) {
                        if (fontConfig.heading['font-family']) {
                            document.getElementById('headingFontFamily').value = fontConfig.heading['font-family'];
                        }
                        
                        if (fontConfig.heading['font-weight']) {
                            document.getElementById('headingFontWeight').value = fontConfig.heading['font-weight'];
                        }
                    }
                    
                    if (fontConfig.body) {
                        if (fontConfig.body['font-family']) {
                            document.getElementById('bodyFontFamily').value = fontConfig.body['font-family'];
                        }
                        
                        if (fontConfig.body['font-weight']) {
                            document.getElementById('bodyFontWeight').value = fontConfig.body['font-weight'];
                        }
                    }
                    
                    if (fontConfig.price) {
                        if (fontConfig.price['font-family']) {
                            document.getElementById('priceFontFamily').value = fontConfig.price['font-family'];
                        }
                        
                        if (fontConfig.price['font-weight']) {
                            document.getElementById('priceFontWeight').value = fontConfig.price['font-weight'];
                        }
                    }
                    
                    if (fontConfig.button) {
                        if (fontConfig.button['font-family']) {
                            document.getElementById('buttonFontFamily').value = fontConfig.button['font-family'];
                        }
                        
                        if (fontConfig.button['font-weight']) {
                            document.getElementById('buttonFontWeight').value = fontConfig.button['font-weight'];
                        }
                    }
                    
                    // Opdater CSS
                    if (styles.css) {
                        document.getElementById('globalCss').value = styles.css;
                    }
                    
                    // Opdater previews
                    updateColorPreview();
                    updateFontPreview();
                }
            } catch (error) {
                console.error('Error loading global styles:', error);
            }
        }
        
        // Gem globale stilarter
        async function saveGlobalStyles() {
            try {
                const colorPalette = {
                    primary: document.getElementById('primaryColor').value,
                    secondary: document.getElementById('secondaryColor').value,
                    accent: document.getElementById('accentColor').value,
                    bright: document.getElementById('brightColor').value,
                    background: document.getElementById('backgroundColor').value,
                    text: document.getElementById('textColor').value
                };
                
                const fontConfig = {
                    heading: {
                        'font-family': document.getElementById('headingFontFamily').value,
                        'font-weight': document.getElementById('headingFontWeight').value
                    },
                    body: {
                        'font-family': document.getElementById('bodyFontFamily').value,
                        'font-weight': document.getElementById('bodyFontWeight').value
                    },
                    price: {
                        'font-family': document.getElementById('priceFontFamily').value,
                        'font-weight': document.getElementById('priceFontWeight').value
                    },
                    button: {
                        'font-family': document.getElementById('buttonFontFamily').value,
                        'font-weight': document.getElementById('buttonFontWeight').value
                    }
                };
                
                const globalStyles = {
                    css: document.getElementById('globalCss').value
                };
                
                const data = {
                    global_styles: globalStyles,
                    font_config: fontConfig,
                    color_palette: colorPalette
                };
                
                const result = await fetchApi('layout/global/styles', 'PUT', data);
                
                if (result.status === 'success') {
                    showToast('Globale stilarter blev gemt');
                }
            } catch (error) {
                console.error('Error saving global styles:', error);
            }
        }
        
        function updateColorPreview() {
            const container = document.getElementById('color-preview-container');
            const primaryColor = document.getElementById('primaryColor').value;
            const secondaryColor = document.getElementById('secondaryColor').value;
            const accentColor = document.getElementById('accentColor').value;
            const brightColor = document.getElementById('brightColor').value;
            const backgroundColor = document.getElementById('backgroundColor').value;
            const textColor = document.getElementById('textColor').value;
            
            container.innerHTML = `
                <div style="width: 80px; height: 80px; background-color: ${primaryColor}; display: flex; align-items: center; justify-content: center; color: white; border-radius: 4px;">Primær</div>
                <div style="width: 80px; height: 80px; background-color: ${secondaryColor}; display: flex; align-items: center; justify-content: center; color: white; border-radius: 4px;">Sekundær</div>
                <div style="width: 80px; height: 80px; background-color: ${accentColor}; display: flex; align-items: center; justify-content: center; color: white; border-radius: 4px;">Accent</div>
                <div style="width: 80px; height: 80px; background-color: ${brightColor}; display: flex; align-items: center; justify-content: center; color: ${textColor}; border-radius: 4px;">Lys Accent</div>
                <div style="width: 80px; height: 80px; background-color: ${backgroundColor}; display: flex; align-items: center; justify-content: center; color: ${textColor}; border-radius: 4px;">Baggrund</div>
            `;
            
            // Set CSS variables
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--secondary-color', secondaryColor);
            document.documentElement.style.setProperty('--accent-color', accentColor);
            document.documentElement.style.setProperty('--bright-color', brightColor);
            document.documentElement.style.setProperty('--background-color', backgroundColor);
            document.documentElement.style.setProperty('--text-color', textColor);
        }
        
        function updateFontPreview() {
            const headingFont = document.getElementById('headingFontFamily').value;
            const headingWeight = document.getElementById('headingFontWeight').value;
            const bodyFont = document.getElementById('bodyFontFamily').value;
            const bodyWeight = document.getElementById('bodyFontWeight').value;
            const priceFont = document.getElementById('priceFontFamily').value;
            const priceWeight = document.getElementById('priceFontWeight').value;
            const buttonFont = document.getElementById('buttonFontFamily').value;
            const buttonWeight = document.getElementById('buttonFontWeight').value;
            
            const previewHeading = document.querySelector('.preview-heading');
            const previewBody = document.querySelector('.preview-body');
            const previewPrice = document.querySelector('.preview-price');
            const previewButton = document.querySelector('.preview-button');
            
            if (previewHeading) {
                previewHeading.style.fontFamily = headingFont;
                previewHeading.style.fontWeight = headingWeight;
            }
            
            if (previewBody) {
                previewBody.style.fontFamily = bodyFont;
                previewBody.style.fontWeight = bodyWeight;
            }
            
            if (previewPrice) {
                previewPrice.style.fontFamily = priceFont;
                previewPrice.style.fontWeight = priceWeight;
            }
            
            if (previewButton) {
                previewButton.style.fontFamily = buttonFont;
                previewButton.style.fontWeight = buttonWeight;
            }
            
            // Set CSS variables
            document.documentElement.style.setProperty('--heading-font', headingFont);
            document.documentElement.style.setProperty('--body-font', bodyFont);
            document.documentElement.style.setProperty('--price-font', priceFont);
            document.documentElement.style.setProperty('--button-font', buttonFont);
        }
        
        // Load layouts
        async function loadLayouts() {
            try {
                const result = await fetchApi('layout');
                
                if (result.status === 'success' && result.data) {
                    layouts = result.data;
                    
                    // Opdater side dropdown
                    const pageSelect = document.getElementById('pageSelect');
                    const bandPageSelect = document.getElementById('bandPageSelect');
                    const bandPage = document.getElementById('band-page');
                    
                    // Ryd eksisterende muligheder
                    pageSelect.innerHTML = '<option value="">-- Vælg side --</option>';
                    bandPageSelect.innerHTML = '<option value="">-- Vælg side --</option>';
                    bandPage.innerHTML = '<option value="">-- Vælg side --</option>';
                    
                    // Tilføj layouts til dropdown
                    layouts.forEach(layout => {
                        if (layout.page_id !== 'global') {
                            const option = document.createElement('option');
                            option.value = layout.page_id;
                            option.textContent = layout.page_id;
                            
                            const bandOption = option.cloneNode(true);
                            const bandPageOption = option.cloneNode(true);
                            
                            pageSelect.appendChild(option);
                            bandPageSelect.appendChild(bandOption);
                            bandPage.appendChild(bandPageOption);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading layouts:', error);
            }
        }
        
        // Håndter sideændring
        async function handlePageChange() {
            const selectedPageId = document.getElementById('pageSelect').value;
            
            if (selectedPageId) {
                try {
                    const result = await fetchApi(`layout/${selectedPageId}`);
                    
                    if (result.status === 'success' && result.data) {
                        const layout = result.data;
                        currentPageId = layout.page_id;
                        
                        document.getElementById('currentPageId').value = layout.page_id;
                        document.getElementById('layoutData').value = JSON.stringify(layout.layout_data || {}, null, 2);
                        
                        document.getElementById('pageDetails').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading page details:', error);
                }
            } else {
                document.getElementById('pageDetails').style.display = 'none';
            }
        }
        
        // Opret ny side
        async function createNewPage() {
            const pageId = document.getElementById('newPageId').value.trim();
            
            if (!pageId) {
                showToast('Indtast et gyldigt side-id', true);
                return;
            }
            
            try {
                const data = {
                    page_id: pageId,
                    layout_data: {}
                };
                
                const result = await fetchApi('layout', 'POST', data);
                
                if (result.status === 'success') {
                    showToast(`Siden "${pageId}" blev oprettet`);
                    document.getElementById('newPageId').value = '';
                    await loadLayouts();
                    
                    // Vælg den nye side
                    document.getElementById('pageSelect').value = pageId;
                    handlePageChange();
                }
            } catch (error) {
                console.error('Error creating page:', error);
            }
        }
        
        // Opdater side
        async function updatePage() {
            if (!currentPageId) {
                showToast('Ingen side valgt', true);
                return;
            }
            
            try {
                let layoutData;
                try {
                    layoutData = JSON.parse(document.getElementById('layoutData').value);
                } catch (e) {
                    showToast('Ugyldig JSON i layout data', true);
                    return;
                }
                
                const data = {
                    layout_data: layoutData
                };
                
                const result = await fetchApi(`layout/${currentPageId}`, 'PUT', data);
                
                if (result.status === 'success') {
                    showToast(`Siden "${currentPageId}" blev opdateret`);
                }
            } catch (error) {
                console.error('Error updating page:', error);
            }
        }
        
        // Slet side
        async function deletePage() {
            if (!currentPageId) {
                showToast('Ingen side valgt', true);
                return;
            }
            
            if (!confirm(`Er du sikker på, at du vil slette siden "${currentPageId}"?`)) {
                return;
            }
            
            try {
                const result = await fetchApi(`layout/${currentPageId}`, 'DELETE');
                
                if (result.status === 'success') {
                    showToast(`Siden "${currentPageId}" blev slettet`);
                    document.getElementById('pageDetails').style.display = 'none';
                    currentPageId = null;
                    await loadLayouts();
                }
            } catch (error) {
                console.error('Error deleting page:', error);
            }
        }
        
        // Load bånd for en side
        async function loadBands() {
            const selectedPageId = document.getElementById('bandPageSelect').value;
            
            if (selectedPageId) {
                try {
                    const result = await fetchApi(`bands/${selectedPageId}`);
                    
                    if (result.status === 'success') {
                        const bands = result.data || [];
                        currentPageId = selectedPageId;
                        
                        const bandsContainer = document.getElementById('bands');
                        bandsContainer.innerHTML = '';
                        
                        if (bands.length === 0) {
                            bandsContainer.innerHTML = '<p>Ingen bånd fundet for denne side.</p>';
                        } else {
                            // Sorter bånd efter rækkefølge
                            bands.sort((a, b) => a.band_order - b.band_order);
                            
                            const template = document.getElementById('band-item-template').innerHTML;
                            
                            bands.forEach((band, index) => {
                                let contentInfo = '';
                                if (band.band_type === 'slideshow' && band.band_content.slides) {
                                    contentInfo = `<strong>Indhold:</strong> ${band.band_content.slides.length} slide(s)`;
                                } else if (band.band_type === 'product') {
                                    contentInfo = `<strong>Indhold:</strong> ${band.band_content.title || 'Uden titel'}`;
                                } else if (band.band_type === 'html') {
                                    contentInfo = '<strong>Indhold:</strong> HTML';
                                } else if (band.band_type === 'link') {
                                    contentInfo = `<strong>Indhold:</strong> Link - ${band.band_content.text || ''}`;
                                }
                                
                                let bandHTML = template
                                    .replace('{id}', band.band_id)
                                    .replace('{title}', band.band_type.charAt(0).toUpperCase() + band.band_type.slice(1).replace('_', ' ') + ' Bånd')
                                    .replace('{type}', band.band_type)
                                    .replace('{height}', band.band_height)
                                    .replace('{order}', band.band_order)
                                    .replace('{content_info}', contentInfo);
                                
                                const bandElement = document.createElement('div');
                                bandElement.innerHTML = bandHTML;
                                bandsContainer.appendChild(bandElement.firstElementChild);
                                
                                // Tilføj event listeners
                                const editBtn = bandsContainer.lastElementChild.querySelector('.edit-band-btn');
                                const moveUpBtn = bandsContainer.lastElementChild.querySelector('.move-up-btn');
                                const moveDownBtn = bandsContainer.lastElementChild.querySelector('.move-down-btn');
                                const deleteBtn = bandsContainer.lastElementChild.querySelector('.delete-band-btn');
                                
                                editBtn.addEventListener('click', () => editBand(band.band_id));
                                moveUpBtn.addEventListener('click', () => moveBand(band.band_id, -1));
                                moveDownBtn.addEventListener('click', () => moveBand(band.band_id, 1));
                                deleteBtn.addEventListener('click', () => deleteBand(band.band_id));
                                
                                // Deaktiver op/ned knapper for første/sidste bånd
                                if (index === 0) {
                                    moveUpBtn.disabled = true;
                                }
                                
                                if (index === bands.length - 1) {
                                    moveDownBtn.disabled = true;
                                }
                            });
                        }
                        
                        document.getElementById('bandList').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading bands:', error);
                    showToast('Fejl ved indlæsning af bånd', true);
                }
            } else {
                document.getElementById('bandList').style.display = 'none';
            }
        }
        
        // Vis band editor
        function showBandEditor() {
            document.getElementById('band-list-view').style.display = 'none';
            document.getElementById('band-editor-view').style.display = 'block';
            document.getElementById('band-editor-title').textContent = 'Tilføj nyt bånd';
            document.getElementById('editBandId').value = '';
            
            // Reset form
            document.getElementById('band-type').value = 'slideshow';
            document.getElementById('band-height').value = '1';
            document.getElementById('band-order').value = '1';
            document.getElementById('band-page').value = currentPageId;
            document.getElementById('slides-container').innerHTML = '';
            slideCount = 0;
            slideImageFiles = {};
            
            // Vis slideshow editor som standard
            toggleEditors();
            
            // Tilføj første slide
            addSlide();
        }
        
        // Skjul band editor
        function hideBandEditor() {
            document.getElementById('band-list-view').style.display = 'block';
            document.getElementById('band-editor-view').style.display = 'none';
        }
        
        // Skift mellem editorer baseret på båndtype
        function toggleEditors() {
            const bandType = document.getElementById('band-type').value;
            
            // Skjul alle editorer
            document.getElementById('slideshow-editor').classList.add('hidden-tab');
            document.getElementById('product-editor').classList.add('hidden-tab');
            document.getElementById('html-editor').classList.add('hidden-tab');
            document.getElementById('link-editor').classList.add('hidden-tab');
            
            // Vis den passende editor
            if (bandType === 'slideshow') {
                document.getElementById('slideshow-editor').classList.remove('hidden-tab');
            } else if (bandType === 'product' || bandType === 'product_card' || bandType === 'product_full') {
                document.getElementById('product-editor').classList.remove('hidden-tab');
            } else if (bandType === 'html') {
                document.getElementById('html-editor').classList.remove('hidden-tab');
            } else if (bandType === 'link') {
                document.getElementById('link-editor').classList.remove('hidden-tab');
            }
            
            updatePreview();
        }
        
        // Tilføj et nyt slide
        function addSlide() {
            const slideIndex = slideCount++;
            const slideHtml = document.getElementById('slide-template').innerHTML
                .replace(/{index}/g, slideIndex)
                .replace(/{index_human}/g, slideIndex + 1);
            
            const slideContainer = document.createElement('div');
            slideContainer.innerHTML = slideHtml;
            document.getElementById('slides-container').appendChild(slideContainer.firstElementChild);
            
            // Tilføj event listeners til det nye slide
            const newSlide = document.getElementById('slides-container').lastElementChild;
            const removeButton = newSlide.querySelector('.remove-slide');
            const moveUpButton = newSlide.querySelector('.move-slide-up');
            const moveDownButton = newSlide.querySelector('.move-slide-down');
            const slideImage = newSlide.querySelector('.slide-image');
            
            removeButton.addEventListener('click', () => removeSlide(newSlide));
            moveUpButton.addEventListener('click', () => moveSlide(newSlide, -1));
            moveDownButton.addEventListener('click', () => moveSlide(newSlide, 1));
            slideImage.addEventListener('change', (e) => handleSlideImageUpload(e, slideIndex));
            
            // Tilføj event listeners til alle input felter for at opdatere forhåndsvisningen
            newSlide.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            
            updateSlideMoveButtons();
            updatePreview();
            
            return newSlide;
        }
        
        // Fjern et slide
        function removeSlide(slideElement) {
            if (document.getElementById('slides-container').children.length <= 1) {
                showToast('Du skal have mindst ét slide', true);
                return;
            }
            
            document.getElementById('slides-container').removeChild(slideElement);
            updateSlideMoveButtons();
            updatePreview();
        }
        
        // Flyt et slide op eller ned
        function moveSlide(slideElement, direction) {
            const slidesContainer = document.getElementById('slides-container');
            const slides = Array.from(slidesContainer.children);
            const currentIndex = slides.indexOf(slideElement);
            const newIndex = currentIndex + direction;
            
            if (newIndex < 0 || newIndex >= slides.length) {
                return;
            }
            
            if (direction < 0) {
                slidesContainer.insertBefore(slideElement, slides[newIndex]);
            } else {
                slidesContainer.insertBefore(slideElement, slides[newIndex].nextElementSibling);
            }
            
            updateSlideMoveButtons();
            updatePreview();
        }
        
        // Opdater op/ned knapper for slides
        function updateSlideMoveButtons() {
            const slidesContainer = document.getElementById('slides-container');
            const slides = Array.from(slidesContainer.children);
            
            slides.forEach((slide, index) => {
                const moveUpButton = slide.querySelector('.move-slide-up');
                const moveDownButton = slide.querySelector('.move-slide-down');
                
                moveUpButton.disabled = index === 0;
                moveDownButton.disabled = index === slides.length - 1;
            });
        }
        
        // Håndter upload af slide billede
        function handleSlideImageUpload(event, slideIndex) {
            const file = event.target.files[0];
            
            if (file) {
                slideImageFiles[slideIndex] = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const slideElement = event.target.closest('.slide-container');
                    const preview = slideElement.querySelector('.slide-image-preview');
                    const img = preview.querySelector('img');
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                updatePreview();
            }
        }
        
        // Håndter upload af produkt billede
        function handleProductImageUpload(event) {
            const file = event.target.files[0];
            
            if (file) {
                productImageFile = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('product-image-preview');
                    const img = preview.querySelector('img');
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                updatePreview();
            }
        }
        
        // Opdater forhåndsvisning
        function updatePreview() {
            const previewContainer = document.getElementById('preview-container');
            const bandType = document.getElementById('band-type').value;
            
            if (bandType === 'slideshow') {
                updateSlideshowPreview(previewContainer);
            } else if (bandType === 'product' || bandType === 'product_card' || bandType === 'product_full') {
                updateProductPreview(previewContainer);
            } else if (bandType === 'html') {
                updateHtmlPreview(previewContainer);
            } else if (bandType === 'link') {
                updateLinkPreview(previewContainer);
            } else {
                previewContainer.innerHTML = '<div style="text-align: center; padding: 20px;">Forhåndsvisning ikke tilgængelig for denne båndtype</div>';
            }
        }
        
        // Opdater slideshow forhåndsvisning
        function updateSlideshowPreview(container) {
            const slidesContainer = document.getElementById('slides-container');
            const slides = Array.from(slidesContainer.children);
            
            if (slides.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px;">Ingen slides at vise</div>';
                return;
            }
            
            let html = '<div style="position: relative; width: 100%; height: 200px; background: #f0f0f0; overflow: hidden;">';
            
            // Vis første slide
            const firstSlide = slides[0];
            const title = firstSlide.querySelector('.slide-title').value || 'Slide titel';
            const subtitle = firstSlide.querySelector('.slide-subtitle').value || 'Slide undertitel';
            const imagePreview = firstSlide.querySelector('.slide-image-preview');
            
            if (imagePreview && imagePreview.style.display !== 'none') {
                const img = imagePreview.querySelector('img');
                html += `<img src="${img.src}" alt="${title}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                html += '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #ddd;">Intet billede valgt</div>';
            }
            
            html += `
                <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background: rgba(0,0,0,0.6); color: white;">
                    <h3 style="margin: 0 0 5px 0;">${title}</h3>
                    <p style="margin: 0;">${subtitle}</p>
                </div>
            `;
            
            // Tilføj indikatorer
            if (slides.length > 1) {
                html += '<div style="position: absolute; bottom: 5px; right: 10px;">';
                for (let i = 0; i < slides.length; i++) {
                    const color = i === 0 ? '#fff' : 'rgba(255,255,255,0.5)';
                    html += `<span style="display: inline-block; width: 10px; height: 10px; margin: 0 2px; border-radius: 50%; background: ${color};"></span>`;
                }
                html += '</div>';
            }
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Opdater produkt forhåndsvisning
        function updateProductPreview(container) {
            const title = document.getElementById('product-title').value || 'Produkttitel';
            const subtitle = document.getElementById('product-subtitle').value || 'Produktbeskrivelse';
            const backgroundColor = document.getElementById('product-background').value || '#ffffff';
            const imagePreview = document.getElementById('product-image-preview');
            
            let html = `<div style="display: flex; background-color: ${backgroundColor}; padding: 15px; height: 200px;">`;
            
            // Billede
            html += '<div style="flex: 1; display: flex; align-items: center; justify-content: center;">';
            if (imagePreview && imagePreview.style.display !== 'none') {
                const img = imagePreview.querySelector('img');
                html += `<img src="${img.src}" alt="${title}" style="max-width: 100%; max-height: 170px;">`;
            } else {
                html += '<div style="width: 100%; height: 170px; display: flex; align-items: center; justify-content: center; background: #ddd;">Intet billede valgt</div>';
            }
            html += '</div>';
            
            // Tekst
            html += `
                <div style="flex: 1; padding: 15px;">
                    <h3 style="margin: 0 0 10px 0;">${title}</h3>
                    <p style="margin: 0 0 20px 0;">${subtitle}</p>
                    <button style="padding: 8px 16px; background: #042940; color: white; border: none; border-radius: 4px;">Læs mere</button>
                </div>
            `;
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Opdater HTML forhåndsvisning
        function updateHtmlPreview(container) {
            const htmlContent = document.getElementById('html-content').value;
            
            if (htmlContent.trim()) {
                container.innerHTML = `
                    <div style="padding: 15px; border: 1px dashed #ccc; background: #f9f9f9;">
                        <div style="font-style: italic; margin-bottom: 10px; color: #666;">HTML Forhåndsvisning:</div>
                        <div>${htmlContent.length > 150 ? htmlContent.substring(0, 150) + '...' : htmlContent}</div>
                    </div>
                `;
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 20px;">Indtast HTML for at se forhåndsvisning</div>';
            }
        }
        
        // Opdater link forhåndsvisning
        function updateLinkPreview(container) {
            const linkText = document.getElementById('link-text').value || 'Link tekst';
            const linkUrl = document.getElementById('link-url').value || '#';
            const linkStyle = document.getElementById('link-style').value;
            
            if (linkStyle === 'button') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <a href="${linkUrl}" style="display: inline-block; padding: 10px 20px; background: #042940; color: white; text-decoration: none; border-radius: 4px;">${linkText}</a>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <a href="${linkUrl}" style="color: #042940; text-decoration: underline;">${linkText}</a>
                    </div>
                `;
            }
        }
        
        // Rediger et bånd
        async function editBand(bandId) {
            try {
                const result = await fetchApi(`bands/${currentPageId}/${bandId}`);
                
                if (result.status === 'success' && result.data) {
                    const band = result.data;
                    
                    // Vis editor
                    document.getElementById('band-list-view').style.display = 'none';
                    document.getElementById('band-editor-view').style.display = 'block';
                    document.getElementById('band-editor-title').textContent = 'Rediger bånd';
                    document.getElementById('editBandId').value = bandId;
                    
                    // Udfyld form med data
                    document.getElementById('band-type').value = band.band_type;
                    document.getElementById('band-height').value = band.band_height;
                    document.getElementById('band-order').value = band.band_order;
                    document.getElementById('band-page').value = currentPageId;
                    
                    // Vis korrekt editor
                    toggleEditors();
                    
                    // Udfyld SEO data
                    if (band.band_content && band.band_content.seo) {
                        document.getElementById('seo-title').value = band.band_content.seo.title || '';
                        document.getElementById('seo-description').value = band.band_content.seo.description || '';
                        document.getElementById('seo-keywords').value = band.band_content.seo.keywords || '';
                    } else {
                        document.getElementById('seo-title').value = '';
                        document.getElementById('seo-description').value = '';
                        document.getElementById('seo-keywords').value = '';
                    }
                    
                    // Udfyld type-specifik data
                    if (band.band_type === 'slideshow') {
                        loadSlideshowData(band);
                    } else if (band.band_type === 'product' || band.band_type === 'product_card' || band.band_type === 'product_full') {
                        loadProductData(band);
                    } else if (band.band_type === 'html') {
                        loadHtmlData(band);
                    } else if (band.band_type === 'link') {
                        loadLinkData(band);
                    }
                    
                    // Opdater preview
                    updatePreview();
                }
            } catch (error) {
                console.error('Error editing band:', error);
                showToast('Fejl ved indlæsning af bånd', true);
            }
        }
        
        // Load slideshow data
        function loadSlideshowData(band) {
            const slides = band.band_content.slides || [];
            
            // Ryd eksisterende slides
            document.getElementById('slides-container').innerHTML = '';
            slideCount = 0;
            slideImageFiles = {};
            
            // Tilføj slides fra båndet
            if (slides.length > 0) {
                slides.forEach(slideData => {
                    const slideElement = addSlide();
                    
                    const titleInput = slideElement.querySelector('.slide-title');
                    const subtitleInput = slideElement.querySelector('.slide-subtitle');
                    const linkInput = slideElement.querySelector('.slide-link');
                    const altInput = slideElement.querySelector('.slide-alt');
                    const imagePreview = slideElement.querySelector('.slide-image-preview');
                    
                    if (slideData.title) {
                        titleInput.value = slideData.title;
                    }
                    
                    if (slideData.subtitle) {
                        subtitleInput.value = slideData.subtitle;
                    }
                    
                    if (slideData.link) {
                        linkInput.value = slideData.link;
                    }
                    
                    if (slideData.alt) {
                        altInput.value = slideData.alt;
                    }
                    
                    if (slideData.image) {
                        const img = imagePreview.querySelector('img');
                        img.src = slideData.image;
                        imagePreview.style.display = 'block';
                    }
                });
            } else {
                // Tilføj et tomt slide
                addSlide();
            }
        }
        
        // Load produkt data
        function loadProductData(band) {
            const content = band.band_content;
            
            if (content.title) {
                document.getElementById('product-title').value = content.title;
            } else {
                document.getElementById('product-title').value = '';
            }
            
            if (content.subtitle) {
                document.getElementById('product-subtitle').value = content.subtitle;
            } else {
                document.getElementById('product-subtitle').value = '';
            }
            
            if (content.link) {
                document.getElementById('product-link').value = content.link;
            } else {
                document.getElementById('product-link').value = '';
            }
            
            if (content.background_color) {
                document.getElementById('product-background').value = content.background_color;
                document.getElementById('product-background-hex').value = content.background_color;
            } else {
                document.getElementById('product-background').value = '#ffffff';
                document.getElementById('product-background-hex').value = '#ffffff';
            }
            
            const preview = document.getElementById('product-image-preview');
            if (content.image) {
                const img = preview.querySelector('img');
                img.src = content.image;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            
            productImageFile = null;
        }
        
        // Load HTML data
        function loadHtmlData(band) {
            const content = band.band_content;
            
            if (content.html) {
                document.getElementById('html-content').value = content.html;
            } else {
                document.getElementById('html-content').value = '';
            }
        }
        
        // Load link data
        function loadLinkData(band) {
            const content = band.band_content;
            
            if (content.text) {
                document.getElementById('link-text').value = content.text;
            } else {
                document.getElementById('link-text').value = '';
            }
            
            if (content.url) {
                document.getElementById('link-url').value = content.url;
            } else {
                document.getElementById('link-url').value = '';
            }
            
            if (content.style) {
                document.getElementById('link-style').value = content.style;
            } else {
                document.getElementById('link-style').value = 'button';
            }
        }
        
        // Gem bånd
        async function saveBand() {
            try {
                // Valider input
                const selectedPageId = currentPageId;
                if (!selectedPageId) {
                    showToast('Vælg venligst en side først', true);
                    return;
                }
                
                // Opret FormData til filer
                const formData = new FormData();
                
                // Indsaml bånd data
                const bandType = document.getElementById('band-type').value;
                const bandHeight = document.getElementById('band-height').value;
                const bandOrder = document.getElementById('band-order').value;
                const bandId = document.getElementById('editBandId').value;
                
                const bandData = {
                    band_type: bandType,
                    band_height: bandHeight,
                    band_order: bandOrder,
                    band_content: {}
                };
                
                // Tilføj SEO data
                const seoTitle = document.getElementById('seo-title').value;
                const seoDescription = document.getElementById('seo-description').value;
                const seoKeywords = document.getElementById('seo-keywords').value;
                
                if (seoTitle || seoDescription || seoKeywords) {
                    bandData.band_content.seo = {
                        title: seoTitle,
                        description: seoDescription,
                        keywords: seoKeywords
                    };
                }
                
                // Indsaml type-specifik data
                if (bandType === 'slideshow') {
                    bandData.band_content.slides = collectSlideshowData(formData);
                } else if (bandType === 'product' || bandType === 'product_card' || bandType === 'product_full') {
                    collectProductData(bandData.band_content, formData);
                } else if (bandType === 'html') {
                    bandData.band_content.html = document.getElementById('html-content').value;
                } else if (bandType === 'link') {
                    bandData.band_content.text = document.getElementById('link-text').value;
                    bandData.band_content.url = document.getElementById('link-url').value;
                    bandData.band_content.style = document.getElementById('link-style').value;
                }
                
                // Tilføj bandData som JSON til FormData
                formData.append('band_data', JSON.stringify(bandData));
                
                // Bestem URL og metode baseret på om vi opretter eller opdaterer
                let url, method;
                if (bandId) {
                    url = `${API_URL}/bands/${selectedPageId}/${bandId}`;
                    method = 'PUT';
                } else {
                    url = `${API_URL}/bands/${selectedPageId}`;
                    method = 'POST';
                }
                
                loading.classList.add('show');
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                const result = await response.json();
                
                loading.classList.remove('show');
                
                if (result.status === 'success') {
                    showToast('Båndet blev gemt');
                    
                    // Gå tilbage til båndlisten
                    hideBandEditor();
                    
                    // Genindlæs bånd
                    await loadBands();
                } else {
                    showToast(result.message || 'Fejl ved gemning af bånd', true);
                }
            } catch (error) {
                console.error('Error saving band:', error);
                showToast('Fejl ved gemning af bånd', true);
                loading.classList.remove('show');
            }
        }
        
        // Indsaml slideshow data
        function collectSlideshowData(formData) {
            const slidesContainer = document.getElementById('slides-container');
            const slides = Array.from(slidesContainer.children);
            const slidesData = [];
            
            slides.forEach((slideElement, index) => {
                const titleInput = slideElement.querySelector('.slide-title');
                const subtitleInput = slideElement.querySelector('.slide-subtitle');
                const linkInput = slideElement.querySelector('.slide-link');
                const altInput = slideElement.querySelector('.slide-alt');
                const imagePreview = slideElement.querySelector('.slide-image-preview');
                
                const slideData = {
                    position: index,
                    title: titleInput.value,
                    subtitle: subtitleInput.value,
                    link: linkInput.value,
                    alt: altInput.value
                };
                
                // Tilføj eksisterende billede hvis det findes
                if (imagePreview && imagePreview.style.display !== 'none') {
                    const img = imagePreview.querySelector('img');
                    const imageUrl = img.src;
                    
                    // Kun tilføj billede hvis det ikke er en data URL (nyt upload)
                    if (!imageUrl.startsWith('data:')) {
                        slideData.image = imageUrl;
                    }
                }
                
                slidesData.push(slideData);
                
                // Tilføj slide billede til FormData hvis det findes
                const slideIndexStr = slideElement.dataset.slideIndex;
                if (slideImageFiles[slideIndexStr]) {
                    formData.append(`slide_images[${index}]`, slideImageFiles[slideIndexStr]);
                }
            });
            
            return slidesData;
        }
        
        // Indsaml produkt data
        function collectProductData(contentObject, formData) {
            contentObject.title = document.getElementById('product-title').value;
            contentObject.subtitle = document.getElementById('product-subtitle').value;
            contentObject.link = document.getElementById('product-link').value;
            contentObject.background_color = document.getElementById('product-background').value;
            
            // Tilføj eksisterende billede hvis det findes
            const imagePreview = document.getElementById('product-image-preview');
            if (imagePreview && imagePreview.style.display !== 'none') {
                const img = imagePreview.querySelector('img');
                const imageUrl = img.src;
                
                // Kun tilføj billede hvis det ikke er en data URL (nyt upload)
                if (!imageUrl.startsWith('data:')) {
                    contentObject.image = imageUrl;
                }
            }
            
            // Tilføj produkt billede til FormData hvis det findes
            if (productImageFile) {
                formData.append('product_image', productImageFile);
            }
        }
        
        // Flyt et bånd op eller ned
        async function moveBand(bandId, direction) {
            try {
                loading.classList.add('show');
                
                // Hent alle bånd
                const result = await fetchApi(`bands/${currentPageId}`);
                
                if (result.status !== 'success') {
                    showToast(result.message || 'Fejl ved flytning af bånd', true);
                    loading.classList.remove('show');
                    return;
                }
                
                const bands = result.data || [];
                
                // Find båndet og dets nabo
                let bandIndex = -1;
                let band = null;
                
                for (let i = 0; i < bands.length; i++) {
                    if (bands[i].band_id === bandId) {
                        bandIndex = i;
                        band = bands[i];
                        break;
                    }
                }
                
                if (bandIndex === -1 || !band) {
                    showToast('Bånd ikke fundet', true);
                    loading.classList.remove('show');
                    return;
                }
                
                const newIndex = bandIndex + direction;
                
                // Kontroller at det nye index er gyldigt
                if (newIndex < 0 || newIndex >= bands.length) {
                    loading.classList.remove('show');
                    return;
                }
                
                const neighborBand = bands[newIndex];
                
                // Byt om på rækkefølgen
                const tempOrder = band.band_order;
                band.band_order = neighborBand.band_order;
                neighborBand.band_order = tempOrder;
                
                // Opdater begge bånd
                await fetchApi(`bands/${currentPageId}/${band.band_id}`, 'PUT', { band_order: band.band_order });
                await fetchApi(`bands/${currentPageId}/${neighborBand.band_id}`, 'PUT', { band_order: neighborBand.band_order });
                
                // Genindlæs bånd
                await loadBands();
                
                loading.classList.remove('show');
                
                showToast('Båndets position blev ændret');
            } catch (error) {
                console.error('Error moving band:', error);
                showToast('Fejl ved flytning af bånd', true);
                loading.classList.remove('show');
            }
        }
        
        // Slet et bånd
        async function deleteBand(bandId) {
            if (!confirm('Er du sikker på, at du vil slette dette bånd?')) {
                return;
            }
            
            try {
                loading.classList.add('show');
                
                const result = await fetchApi(`bands/${currentPageId}/${bandId}`, 'DELETE');
                
                if (result.status === 'success') {
                    showToast('Båndet blev slettet');
                    await loadBands();
                } else {
                    showToast(result.message || 'Fejl ved sletning af bånd', true);
                }
                
                loading.classList.remove('show');
            } catch (error) {
                console.error('Error deleting band:', error);
                showToast('Fejl ved sletning af bånd', true);
                loading.classList.remove('show');
            }
        }
    </script>
</body>
</html>
