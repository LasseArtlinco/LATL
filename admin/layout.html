// This script should be added to the end of the existing script in admin/layout.html
// It completes the missing functions

// Save new band
async function saveNewBand() {
    const selectedPageId = document.getElementById('bandPageSelect').value;
    
    if (!selectedPageId) {
        showToast('Ingen side valgt', true);
        return;
    }
    
    try {
        // Hent eksisterende layout
        const result = await fetchApi(`layout/${selectedPageId}`);
        
        if (result.status === 'success' && result.data) {
            const layout = result.data;
            let bands = layout.bands || [];
            
            // Hent form data
            const bandType = document.getElementById('newBandType').value;
            const bandHeight = parseInt(document.getElementById('newBandHeight').value);
            const bandOrder = parseInt(document.getElementById('newBandOrder').value);
            
            let bandContent;
            try {
                bandContent = JSON.parse(document.getElementById('newBandContent').value);
            } catch (e) {
                showToast('Ugyldig JSON i bånd indhold', true);
                return;
            }
            
            // Generer nyt band ID
            const bandId = Date.now();
            
            // Opret nyt band
            const newBand = {
                id: bandId,
                band_type: bandType,
                band_height: bandHeight,
                band_order: bandOrder,
                band_content: bandContent
            };
            
            // Juster rækkefølge for eksisterende bånd hvis nødvendigt
            bands = bands.map(band => {
                if (band.band_order >= bandOrder) {
                    return {
                        ...band,
                        band_order: band.band_order + 1
                    };
                }
                return band;
            });
            
            // Tilføj nyt bånd
            bands.push(newBand);
            
            // Opdater layout
            const updatedLayout = {
                ...layout,
                bands: bands
            };
            
            // Gem opdateret layout
            const updateResult = await fetchApi(`layout/${selectedPageId}`, 'PUT', {
                layout_data: updatedLayout.layout_data,
                bands: bands
            });
            
            if (updateResult.status === 'success') {
                showToast('Nyt bånd blev tilføjet');
                document.getElementById('newBandForm').style.display = 'none';
                document.getElementById('bandList').style.display = 'block';
                await loadBands();
            }
        }
    } catch (error) {
        console.error('Error saving new band:', error);
    }
}

// Rediger band
function editBand(band) {
    document.getElementById('bandList').style.display = 'none';
    document.getElementById('newBandForm').style.display = 'none';
    document.getElementById('editBandForm').style.display = 'block';
    
    document.getElementById('editBandId').value = band.id;
    document.getElementById('editBandType').value = band.band_type;
    document.getElementById('editBandHeight').value = band.band_height;
    document.getElementById('editBandOrder').value = band.band_order;
    document.getElementById('editBandContent').value = JSON.stringify(band.band_content || {}, null, 2);
}

// Opdater band
async function updateBand() {
    const selectedPageId = document.getElementById('bandPageSelect').value;
    const bandId = parseInt(document.getElementById('editBandId').value);
    
    if (!selectedPageId || !bandId) {
        showToast('Ingen side eller bånd valgt', true);
        return;
    }
    
    try {
        // Hent eksisterende layout
        const result = await fetchApi(`layout/${selectedPageId}`);
        
        if (result.status === 'success' && result.data) {
            const layout = result.data;
            let bands = layout.bands || [];
            
            // Find det band der skal opdateres
            const bandIndex = bands.findIndex(b => b.id === bandId);
            
            if (bandIndex === -1) {
                showToast('Båndet blev ikke fundet', true);
                return;
            }
            
            // Hent form data
            const bandType = document.getElementById('editBandType').value;
            const bandHeight = parseInt(document.getElementById('editBandHeight').value);
            const newBandOrder = parseInt(document.getElementById('editBandOrder').value);
            const oldBandOrder = bands[bandIndex].band_order;
            
            let bandContent;
            try {
                bandContent = JSON.parse(document.getElementById('editBandContent').value);
            } catch (e) {
                showToast('Ugyldig JSON i bånd indhold', true);
                return;
            }
            
            // Juster rækkefølge for eksisterende bånd hvis nødvendigt
            if (newBandOrder !== oldBandOrder) {
                if (newBandOrder < oldBandOrder) {
                    // Flytter op - øg rækkefølge for de der er imellem
                    bands = bands.map(band => {
                        if (band.id !== bandId && band.band_order >= newBandOrder && band.band_order < oldBandOrder) {
                            return {
                                ...band,
                                band_order: band.band_order + 1
                            };
                        }
                        return band;
                    });
                } else {
                    // Flytter ned - reducer rækkefølge for de der er imellem
                    bands = bands.map(band => {
                        if (band.id !== bandId && band.band_order <= newBandOrder && band.band_order > oldBandOrder) {
                            return {
                                ...band,
                                band_order: band.band_order - 1
                            };
                        }
                        return band;
                    });
                }
            }
            
            // Opdater båndet
            bands[bandIndex] = {
                ...bands[bandIndex],
                band_type: bandType,
                band_height: bandHeight,
                band_order: newBandOrder,
                band_content: bandContent
            };
            
            // Opdater layout
            const updatedLayout = {
                ...layout,
                bands: bands
            };
            
            // Gem opdateret layout
            const updateResult = await fetchApi(`layout/${selectedPageId}`, 'PUT', {
                layout_data: updatedLayout.layout_data,
                bands: bands
            });
            
            if (updateResult.status === 'success') {
                showToast('Båndet blev opdateret');
                document.getElementById('editBandForm').style.display = 'none';
                document.getElementById('bandList').style.display = 'block';
                await loadBands();
            }
        }
    } catch (error) {
        console.error('Error updating band:', error);
    }
}

// Slet band
async function deleteBand() {
    const selectedPageId = document.getElementById('bandPageSelect').value;
    const bandId = parseInt(document.getElementById('editBandId').value);
    
    if (!selectedPageId || !bandId) {
        showToast('Ingen side eller bånd valgt', true);
        return;
    }
    
    if (!confirm('Er du sikker på, at du vil slette dette bånd?')) {
        return;
    }
    
    try {
        // Hent eksisterende layout
        const result = await fetchApi(`layout/${selectedPageId}`);
        
        if (result.status === 'success' && result.data) {
            const layout = result.data;
            let bands = layout.bands || [];
            
            // Find det band der skal slettes
            const bandIndex = bands.findIndex(b => b.id === bandId);
            
            if (bandIndex === -1) {
                showToast('Båndet blev ikke fundet', true);
                return;
            }
            
            const deletedBandOrder = bands[bandIndex].band_order;
            
            // Fjern båndet
            bands.splice(bandIndex, 1);
            
            // Juster rækkefølge for resterende bånd
            bands = bands.map(band => {
                if (band.band_order > deletedBandOrder) {
                    return {
                        ...band,
                        band_order: band.band_order - 1
                    };
                }
                return band;
            });
            
            // Opdater layout
            const updatedLayout = {
                ...layout,
                bands: bands
            };
            
            // Gem opdateret layout
            const updateResult = await fetchApi(`layout/${selectedPageId}`, 'PUT', {
                layout_data: updatedLayout.layout_data,
                bands: bands
            });
            
            if (updateResult.status === 'success') {
                showToast('Båndet blev slettet');
                document.getElementById('editBandForm').style.display = 'none';
                document.getElementById('bandList').style.display = 'block';
                await loadBands();
            }
        }
    } catch (error) {
        console.error('Error deleting band:', error);
    }
}

// Ændre rækkefølge af bånd
async function changeBandOrder(band, direction) {
    const selectedPageId = document.getElementById('bandPageSelect').value;
    
    if (!selectedPageId) {
        showToast('Ingen side valgt', true);
        return;
    }
    
    try {
        // Hent eksisterende layout
        const result = await fetchApi(`layout/${selectedPageId}`);
        
        if (result.status === 'success' && result.data) {
            const layout = result.data;
            let bands = layout.bands || [];
            
            // Sorter efter rækkefølge
            bands.sort((a, b) => a.band_order - b.band_order);
            
            // Find det band der skal flyttes
            const bandIndex = bands.findIndex(b => b.id === band.id);
            
            if (bandIndex === -1) {
                showToast('Båndet blev ikke fundet', true);
                return;
            }
            
            // Find det band der skal byttes med
            const otherBandIndex = bandIndex + direction;
            
            if (otherBandIndex < 0 || otherBandIndex >= bands.length) {
                return; // Kan ikke flytte yderligere
            }
            
            // Byt rækkefølge
            const tempOrder = bands[bandIndex].band_order;
            bands[bandIndex].band_order = bands[otherBandIndex].band_order;
            bands[otherBandIndex].band_order = tempOrder;
            
            // Opdater layout
            const updatedLayout = {
                ...layout,
                bands: bands
            };
            
            // Gem opdateret layout
            const updateResult = await fetchApi(`layout/${selectedPageId}`, 'PUT', {
                layout_data: updatedLayout.layout_data,
                bands: bands
            });
            
            if (updateResult.status === 'success') {
                showToast('Rækkefølgen blev ændret');
                await loadBands();
            }
        }
    } catch (error) {
        console.error('Error changing band order:', error);
    }
}

// Initialiser app når siden er loaded
document.addEventListener('DOMContentLoaded', init);
